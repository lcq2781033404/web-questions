### 1 定义
Cross-Site Scripting（跨站脚本攻击）简称 XSS（为了和 CSS 区分，这里把攻击的第一个字母改成了 X，于是叫做 XSS。），是一种**代码注入攻击**。攻击者通过在目标网站上注入恶意脚本，使之在用户的浏览器上运行。利用这些恶意脚本，攻击者可获取用户的敏感信息如Cookie、SessionID等，进而危害数据安全。

XSS 的**本质**是：**恶意代码未经过滤**，与网站正常的代码混在一起；浏览器无法分辨哪些脚本是可信的，导致恶意脚本被执行。（**由于直接在用户的终端执行，恶意代码能够直接获取用户的信息**）

### 2. XSS分类
根据攻击的来源，XSS 攻击可分为**存储型**、**反射型**和 **DOM 型**三种。

#### 2.1 存储型XSS攻击
存储型XSS攻击把恶意代码提交并存储到数据库，当需要显示数据库的内容时，恶意代码被浏览器执行攻击用户，存储型XSS攻击步骤：

- 攻击者将恶意代码提交到目标网站的**数据库**中。
- 用户打开目标网站时，网站**服务端**将恶意代码从数据库取出，**拼接在 HTML 中返回给浏览器**。
- 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
- 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

这种攻击常见于带有用户**保存数据**的网站功能，如论坛发帖、商品评论、用户私信等。

#### 2.2 反射型XSS攻击
反射型 XSS 的攻击步骤：

- 攻击者构造出特殊的 **URL**，其中包含恶意代码。
- 用户打开带有恶意代码的 URL 时，网站**服务端**将恶意代码从 URL 中取出，**拼接在 HTML 中返回给浏览器**。
- 用户浏览器接收到响应后解析执行，混在其中的恶意代码也被执行。
- 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

反射型 XSS 跟存储型 XSS 的区别是：**存储型 XSS 的恶意代码存在数据库里，反射型 XSS 的恶意代码存在 URL 里**。

反射型 XSS 漏洞常见于**通过 URL 传递参数**的功能，如网站搜索、跳转等。由于需要用户主动打开恶意的 URL 才能生效，攻击者往往会结合多种手段诱导用户点击。

#### 2.3 DOM型XSS攻击
DOM 型 XSS 的攻击步骤：

- 攻击者构造出特殊的 URL，其中包含恶意代码。
- 用户打开带有恶意代码的 URL，**前端** JavaScript 取出 URL 中的恶意代码并执行。
- 恶意代码窃取用户数据并发送到攻击者的网站，或者冒充用户的行为，调用目标网站接口执行攻击者指定的操作。

DOM 型 XSS 跟前两种 XSS 的区别：**DOM 型 XSS 攻击中，取出和执行恶意代码由浏览器端完成，属于前端 JavaScript 自身的安全漏洞，而其他两种 XSS 都属于服务端的安全漏洞**。

### 3. XSS攻击的预防

#### 3.1 采用前端渲染（预防存储型和反射型XSS）
对于存储型和反射型XSS攻击，改成前端渲染可以**避免后端拼接HTML并返回给前端**，前端通过代码生成页面HTML，对于修改页面内容的操作，**前端也需要注意：对于动态设置的内容，避免使用innerHTML赋值，应该使用innerText这种不会解析代码的纯文本**。

#### 3.2 转义HTML（预防存储型和反射型XSS）
如果项目需要，必须采用服务端渲染，那么需要选择合适的**转义库**，对 HTML 模板各处**插入点进行充分的转义**。

#### 3.3 前端编码要规范（预防DOM型XSS）
存储型和反射型XSS属于服务端安全漏洞，前端能做的工作有限。

但是，DOM 型 XSS 攻击，实际上就是网站**前端 JavaScript 代码本身不够严谨**，把不可信的数据当作代码执行了。前端在修改页面内容是要格外注意：
- 在使用 **.innerHTML**、**.outerHTML**、**document.write()** 时要特别小心，不要把不可信的数据作为 HTML 插到页面上，而应尽量使用 **.textContent**、**.setAttribute()** 等。
- 如果用 Vue/React 技术栈，并且不使用 v-html/dangerouslySetInnerHTML 功能，就在前端 render 阶段避免 innerHTML、outerHTML 的 XSS 隐患。
- DOM 中的**内联事件监听器**，如 location、onclick、onerror、onload、onmouseover 等，\<a> 标签的 **href** 属性，JavaScript 的 eval()、setTimeout()、setInterval() 等，都能**把字符串作为代码运行**。项目中如果使用了这些，**务必避免在字符串中拼接不可信数据**。

#### 3.4 其他措施
有一些通用的方案，可以增加XSS攻击的成本，降低XSS带来的风险：
- 配置CSP（Content Security Policy，内容安全策略），一种以可信白名单作机制，来限制网站是否可以包含某些来源内容。简单来说，就是**我们能够规定，我们的网站只接受我们指定的请求资源**。
- 限制输入内容长度：虽然无法完全防止 XSS 发生，但可以增加 XSS 攻击的难度。



