### 1. 定义
CSRF（Cross-site request forgery）**跨站请求伪造**：攻击者诱导受害者进入第三方网站，**在第三方网站中**，向被攻击网站发送跨站请求。利用受害者在被攻击网站已经获取的注册凭证，绕过后台的用户验证，达到**冒充用户**对被攻击的网站执行某项操作的目的。

一个典型的CSRF攻击有着如下的流程：

- 受害者登录a.com，并保留了登录凭证（Cookie）。
- 攻击者引诱受害者访问了b.com。
- b.com 向 a.com 发送了一个请求：a.com\/act=xx。浏览器会默认携带a.com的Cookie。
- a.com接收到请求后，对请求进行验证，并确认是受害者的凭证，误以为是受害者自己发送的请求。
- a.com以受害者的名义执行了act=xx。
- 攻击完成，攻击者在受害者不知情的情况下，冒充受害者，让a.com执行了自己定义的操作。

### 2. CSRF攻击类型

#### 2.1 GET类型的CSRF
用户打开第三方页面，通过页面URL直接向被攻击网站发起GET类型的请求。

#### 2.2 POST类型的CSRF
这种类型的CSRF利用起来通常使用的是一个**自动提交**的表单，如：
```
<form action="http://bank.example/withdraw" method=POST>
    <input type="hidden" name="account" value="xiaoming" />
    <input type="hidden" name="amount" value="10000" />
    <input type="hidden" name="for" value="hacker" />
</form>
<script> document.forms[0].submit(); </script> 
```
访问该页面后，表单会自动提交，相当于**模拟用户完成了一次POST操作**。

#### 2.3 链接类型的CSRF
链接类型的CSRF并不常见，比起其他两种用户打开页面就中招的情况，这种**需要用户点击链接**才会触发。攻击者通常会以比较夸张的词语诱骗用户点击，例如：
```
 <a href="http://test.com/csrf/withdraw.php?amount=1000&for=hacker" taget="_blank">
  重磅消息！！
 <a/>
 ```
 由于之前用户登录了信任的网站A，并且保存登录状态，只要用户主动访问上面的这个PHP页面，则表示攻击成功。
 
 ### 3. CSRF的特点
- 攻击一般发起在**第三方网站**，而不是被攻击的网站。被攻击的网站无法防止攻击发生。
- 攻击利用受害者在被攻击网站的登录凭证，**冒充受害者提交操作**；而不是直接窃取数据。
- **整个过程攻击者并不能获取到受害者的登录凭证，仅仅是“冒用”**（很关键！！！）。
- 跨站请求可以用各种方式：图片URL、超链接、CORS、Form提交等等。部分请求方式可以直接嵌入在第三方论坛、文章中，难以进行追踪。
- CSRF通常是跨域的，因为外域通常更容易被攻击者掌控。但是如果本域下有容易被利用的功能，比如可以发图和链接的论坛和评论区，攻击可以直接在本域下进行，而且这种攻击更加危险。

### 4. CSRF防护策略

#### 4.1 同源检测
禁止外域对我们发起请求，在http协议中通过请求header的Origin Header和Referer Header 属性来**判断请求是否来自外域**

弊端：
- CSRF大多数情况下来自第三方域名，但并不能排除本域发起。如果在本域发起，则同源检测无效

#### 4.2 token方式
由于CSRF攻击并不能获取登录凭证，只是盗用登录凭证。所以可以给每一个请求的header上面都加一个token，只有携带了token的请求才被认为是用户发起的请求。（jwt鉴权）

token是一个比较有效的CSRF防护方法，只要**页面没有XSS漏洞泄露token**，那么接口的CSRF攻击就无法成功。

